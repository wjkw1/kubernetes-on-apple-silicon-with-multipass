#cloud-config

package_update: true
package_upgrade: false
packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gpg
  - etcd-client
  - jq

write_files:
  - path: "/root/setup-node.sh"
    owner: "root:root"
    permissions: !!str "0755"
    content: |
      #!/bin/bash -e
      set -euo pipefail
      # === BEGIN user script ===
      echo -e "Install containerd..."
      # Add Docker's official GPG key:
      sudo install -m 0755 -d /etc/apt/keyrings
      sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
      sudo chmod a+r /etc/apt/keyrings/docker.asc
      # Add the repository to Apt sources:
      sudo tee /etc/apt/sources.list.d/docker.sources <<EOF
      Types: deb
      URIs: https://download.docker.com/linux/ubuntu
      Suites: $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}")
      Components: stable
      Signed-By: /etc/apt/keyrings/docker.asc
      EOF
      sudo apt-get update
      sudo apt-get install -y containerd.io
      # Configure cgroup drivers 
      # https://kubernetes.io/docs/setup/production-environment/container-runtimes/#systemd-cgroup-driver
      # Overwrite config.toml to ensure correct settings
      sudo containerd config default | sudo tee /etc/containerd/config.toml
      sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml || true
      sudo systemctl enable --now containerd.service
      # disable swap as a precaution
      sudo swapoff -a
      sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab

      # Configure crictl for runtime debugging
      cat <<EOF | sudo tee /etc/crictl.yaml
      runtime-endpoint: unix:///run/containerd/containerd.sock
      image-endpoint: unix:///run/containerd/containerd.sock
      timeout: 10
      debug: false
      EOF
      echo -e "Install kubeadm and others..."
      curl -fsSL "https://pkgs.k8s.io/core:/stable:/${K8S_MINOR_VERSION}/deb/Release.key" | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      # This overwrites any existing configuration in /etc/apt/sources.list.d/kubernetes.list
      echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/${K8S_MINOR_VERSION}/deb/ /" | sudo tee /etc/apt/sources.list.d/kubernetes.list
      sudo apt-get update
      sudo apt-get install -y kubelet kubeadm kubectl kubernetes-cni
      sudo apt-mark hold kubelet kubeadm kubectl kubernetes-cni
      sudo systemctl enable --now kubelet

      # Configure prerequisites 
      # Ref: https://kubernetes.io/docs/setup/production-environment/container-runtimes/#install-and-configure-prerequisites
      echo -e "Configure os settings..."

      cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
      overlay
      br_netfilter
      EOF

      sudo modprobe overlay
      sudo modprobe br_netfilter

      cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
      net.bridge.bridge-nf-call-iptables  = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward                 = 1
      EOF

      sudo sysctl --system

      # Reload configuration and Restart daemon
      echo -e "Reload and Restart daemons..."
      sudo sysctl -p
      sudo systemctl daemon-reload
      sudo systemctl restart kubelet
      sudo systemctl restart containerd.service

      # Configure bash
      echo -e "Configure os settings..."
      echo "source <(kubectl completion bash)" >> /home/ubuntu/.bashrc
      echo "alias k=kubectl" >> /home/ubuntu/.bashrc
      echo "complete -o default -F __start_kubectl k" >> /home/ubuntu/.bashrc

      echo -e "Setup has been completed."
      # Version info
      echo -e "\n- containerd:"
      containerd -v
      echo -e "\n- runc:"
      runc --version
      echo -e "\n- crictl:"
      crictl -v
      echo -e "\n- kubectl:"
      kubectl version --client=true
      echo -e "\n- kubelet:"
      kubelet --version
      echo -e "\n- kubeadm:"
      kubeadm version
      # === END user script ===
  - path: /root/setup-k8s-repo.sh
    owner: "root:root"
    permissions: !!str "0755"
    content: |
      #!/bin/bash
      set -euo pipefail
      K8S_MINOR="${1:-v1.35}"

      sudo mkdir -p -m 755 /etc/apt/keyrings
      curl -fsSL "https://pkgs.k8s.io/core:/stable:/${K8S_MINOR}/deb/Release.key" \
        | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

      echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/${K8S_MINOR}/deb/ /" \
        | sudo tee /etc/apt/sources.list.d/kubernetes.list

      sudo apt-get update
runcmd:
  - [ bash, -c, "K8S_MINOR_VERSION=v1.34 /root/setup-node.sh > /var/log/setup-node.log 2>&1" ]
